use teloxide::types::ChatId;
use teloxide::Bot;
use super::storage::JsonStorage;
use super::weather::WeatherClient;
use chrono::{Local, Datelike, Weekday, DateTime, Timelike, Utc};
use tokio::time::{sleep, Duration};
use std::sync::Arc;
use teloxide::payloads::SendMessageSetters;
use teloxide::prelude::Requester;
use rand::Rng;
use log::{info, error, warn};

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ Markdown
fn escape_markdown_v2(text: &str) -> String {
    let special_chars = ['_', '*', '[', ']', '(', ')', '~', '`', '>', '#', '+', '-', '=', '|', '{', '}', '.', '!'];
    let mut result = String::with_capacity(text.len() * 2); // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏
    
    for ch in text.chars() {
        if special_chars.contains(&ch) {
            result.push('\\');
        }
        result.push(ch);
    }
    
    result
}

pub async fn start_scheduler(bot: Bot, storage: Arc<JsonStorage>, weather_client: WeatherClient) {
    info!("–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∑–∞–ø—É—â–µ–Ω. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É");
    
    loop {
        // –£–¥–∞–ª—è–µ–º webhook –≤ –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ü–∏–∫–ª–∞ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
        if let Err(e) = bot.delete_webhook().await {
            error!("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ webhook –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–µ: {}", e);
        }
        
        let now = Local::now();
        let now_time = now.format("%H:%M").to_string();
        let today = now.weekday();
        
        info!("–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π [{}]", now_time);
        
        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
        let users = storage.get_all_users().await;
        info!("–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –±–∞–∑–µ: {}", users.len());

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞—Å—Ç–∞–ª–æ –ª–∏ –≤—Ä–µ–º—è –¥–ª—è –º–∞—Å—Å–æ–≤–æ–π —Ä–∞—Å—Å—ã–ª–∫–∏ (12:00 –∏–ª–∏ 18:00)
        let hours = now.hour();
        let minutes = now.minute();
        let is_mass_notification_time = (hours == 12 || hours == 18) && minutes == 0;
        
        info!("–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è: {}, –º–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞: {}", now_time, is_mass_notification_time);
        
        if is_mass_notification_time {
            info!("–í—Ä–µ–º—è –º–∞—Å—Å–æ–≤–æ–π —Ä–∞—Å—Å—ã–ª–∫–∏ [{}]. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.", now_time);
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª—è–µ–º webhook –ø–µ—Ä–µ–¥ –º–∞—Å—Å–æ–≤–æ–π —Ä–∞—Å—Å—ã–ª–∫–æ–π
            if let Err(e) = bot.delete_webhook().await {
                error!("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ webhook –ø–µ—Ä–µ–¥ –º–∞—Å—Å–æ–≤–æ–π —Ä–∞—Å—Å—ã–ª–∫–æ–π: {}", e);
            } else {
                info!("Webhook —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω –ø–µ—Ä–µ–¥ –º–∞—Å—Å–æ–≤–æ–π —Ä–∞—Å—Å—ã–ª–∫–æ–π");
            }
            
            send_mass_notifications(&bot, &users, &weather_client, &now_time, today).await;
            
            // –°–Ω–æ–≤–∞ —É–¥–∞–ª—è–µ–º webhook –ø–æ—Å–ª–µ –º–∞—Å—Å–æ–≤–æ–π —Ä–∞—Å—Å—ã–ª–∫–∏
            if let Err(e) = bot.delete_webhook().await {
                error!("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ webhook –ø–æ—Å–ª–µ –º–∞—Å—Å–æ–≤–æ–π —Ä–∞—Å—Å—ã–ª–∫–∏: {}", e);
            } else {
                info!("Webhook —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω –ø–æ—Å–ª–µ –º–∞—Å—Å–æ–≤–æ–π —Ä–∞—Å—Å—ã–ª–∫–∏");
            }
        }

        // –û–±—ã—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        for user in users {
            if let Some(scheduled_time) = &user.notification_time {
                if scheduled_time == &now_time {
                    if let Some(city) = &user.city {
                        info!("–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ID: {}, –≥–æ—Ä–æ–¥: {}", user.user_id, city);
                        
                        // –ü–æ–ª—É—á–∞–µ–º –ø–æ–≥–æ–¥—É
                        match weather_client.get_weather(city).await {
                            Ok(weather_text) => {
                                // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞ –±–æ—Ç–∞
                                let message = if user.cute_mode {
                                    // –ú–∏–ª—ã–π —Ä–µ–∂–∏–º: —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º –∏ –º–∏–ª—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
                                    // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                                    let greeting = get_greeting(today);
                                    let cute_message = get_cute_message();
                                    let good_day_wish = get_good_day_wish();
                                    
                                    // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
                                    format!("{}\n\nüå¶ *–ü–æ–≥–æ–¥–∞ –≤ {}*\n\n{}\n\n{}\n\n{}", 
                                        escape_markdown_v2(&greeting), 
                                        escape_markdown_v2(city), 
                                        escape_markdown_v2(&weather_text), 
                                        escape_markdown_v2(&cute_message), 
                                        escape_markdown_v2(&good_day_wish))
                                } else {
                                    // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ä–µ–∂–∏–º: —Ç–æ–ª—å–∫–æ –ø–æ–≥–æ–¥–∞
                                    format!("üåÖ *–£—Ç—Ä–µ–Ω–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã*\n\nüå¶ *–ü–æ–≥–æ–¥–∞ –≤ {}*\n\n{}", 
                                        escape_markdown_v2(city), 
                                        escape_markdown_v2(&weather_text))
                                };
                                
                                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                                if let Err(e) = bot.send_message(ChatId(user.user_id), message)
                                    .parse_mode(teloxide::types::ParseMode::MarkdownV2)
                                    .await 
                                {
                                    error!("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {}: {}", user.user_id, e);
                                } else {
                                    info!("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ID: {}", user.user_id);
                                }
                            }
                            Err(e) => {
                                warn!("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–≥–æ–¥—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {}: {}", user.user_id, e);
                                
                                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                                let error_message = if user.cute_mode {
                                    format!("–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ\\! –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–≥–æ–¥–µ: {}", 
                                        escape_markdown_v2(&e.to_string()))
                                } else {
                                    format!("‚ùå *–û—à–∏–±–∫–∞*: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–≥–æ–¥–µ: {}", 
                                        escape_markdown_v2(&e.to_string()))
                                };
                                
                                if let Err(e) = bot.send_message(
                                    ChatId(user.user_id),
                                    error_message
                                ).parse_mode(teloxide::types::ParseMode::MarkdownV2).await {
                                    error!("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {}: {}", user.user_id, e);
                                }
                            }
                        }
                    } else {
                        warn!("–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID: {} –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≥–æ—Ä–æ–¥", user.user_id);
                    }
                }
            }
        }
        
        // –ñ–¥–µ–º –º–∏–Ω—É—Ç—É –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π
        info!("–°–ª–µ–¥—É—é—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è —á–µ—Ä–µ–∑ 1 –º–∏–Ω—É—Ç—É");
        sleep(Duration::from_secs(60)).await;
    }
}

// –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å —É—á–µ—Ç–æ–º –¥–Ω—è –Ω–µ–¥–µ–ª–∏
fn get_greeting(day: Weekday) -> String {
    match day {
        Weekday::Mon => "*–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ, –º–∏–ª–∞—è!* ‚ú®\n–ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –Ω–æ–≤–∞—è –Ω–µ–¥–µ–ª—è, –∏ —è –∑–Ω–∞—é, —á—Ç–æ —Ç—ã —Å–ø—Ä–∞–≤–∏—à—å—Å—è —Å–æ –≤—Å–µ–º!".to_string(),
        Weekday::Tue => "*–î–æ–±—Ä–æ–µ —É—Ç—Ä–µ—á–∫–æ!* üå∏\n–£–∂–µ –≤—Ç–æ—Ä–Ω–∏–∫! –î–µ–Ω—å, –∫–æ–≥–¥–∞ –º–æ–∂–Ω–æ –≥–æ—Ä—ã —Å–≤–µ—Ä–Ω—É—Ç—å!".to_string(),
        Weekday::Wed => "*–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ, —Å–æ–ª–Ω—ã—à–∫–æ!* üí´\n–°–µ—Ä–µ–¥–∏–Ω–∞ –Ω–µ–¥–µ–ª–∏ - –≤—Ä–µ–º—è –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö —Ä–∞–¥–æ—Å—Ç–µ–π!".to_string(),
        Weekday::Thu => "*–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ, –∫—Ä–∞—Å–æ—Ç–∫–∞!* üåø\n–ß–µ—Ç–≤–µ—Ä–≥ - –ø–æ—á—Ç–∏ –ø—è—Ç–Ω–∏—Ü–∞! –¢—ã –º–æ–ª–æ–¥–µ—Ü!".to_string(),
        Weekday::Fri => "*–° –¥–æ–±—Ä—ã–º —É—Ç—Ä–æ–º!* üéâ\n–ü—è—Ç–Ω–∏—Ü–∞ –Ω–∞—Å—Ç—É–ø–∏–ª–∞! –í–ø–µ—Ä–µ–¥–∏ –≤—ã—Ö–æ–¥–Ω—ã–µ!".to_string(),
        Weekday::Sat => "*–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ!* ‚òÄÔ∏è\n–ù–∞–∫–æ–Ω–µ—Ü-—Ç–æ —Å—É–±–±–æ—Ç–∞! –í—Ä–µ–º—è –¥–ª—è –æ—Ç–¥—ã—Ö–∞ –∏ –ø—Ä–∏—è—Ç–Ω—ã—Ö –¥–µ–ª!".to_string(),
        Weekday::Sun => "*–î–æ–±—Ä–æ–µ —É—Ç—Ä–µ—á–∫–æ!* üå§Ô∏è\n–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ - –∏–¥–µ–∞–ª—å–Ω—ã–π –¥–µ–Ω—å, —á—Ç–æ–±—ã –ø–æ–±–∞–ª–æ–≤–∞—Ç—å —Å–µ–±—è!".to_string(),
    }
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∏–ª–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
fn get_cute_message() -> String {
    let messages = [
        "–¢—ã —Å–∞–º–∞—è –ø—Ä–µ–∫—Ä–∞—Å–Ω–∞—è! –ù–µ –∑–∞–±—ã–≤–∞–π —É–ª—ã–±–∞—Ç—å—Å—è —Å–µ–≥–æ–¥–Ω—è! üíï",
        "–¢–≤–æ—è —É–ª—ã–±–∫–∞ —Å–ø–æ—Å–æ–±–Ω–∞ –æ—Å–≤–µ—Ç–∏—Ç—å –¥–∞–∂–µ —Å–∞–º—ã–π –ø–∞—Å–º—É—Ä–Ω—ã–π –¥–µ–Ω—å! üíñ",
        "–ù–µ –ø–æ–∑–≤–æ–ª—è–π –Ω–∏–∫–æ–º—É –∏—Å–ø–æ—Ä—Ç–∏—Ç—å —Ç–≤–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è! –¢—ã –∑–∞—Å–ª—É–∂–∏–≤–∞–µ—à—å —Ç–æ–ª—å–∫–æ —Å—á–∞—Å—Ç—å—è! ‚ú®",
        "–°–µ–≥–æ–¥–Ω—è –æ—Ç–ª–∏—á–Ω—ã–π –¥–µ–Ω—å, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —á—Ç–æ-—Ç–æ –Ω–æ–≤–æ–µ! –Ø –≤–µ—Ä—é –≤ —Ç–µ–±—è! üåü",
        "–ü–æ–º–Ω–∏, —á—Ç–æ —Ç—ã –æ—Å–æ–±–µ–Ω–Ω–∞—è –∏ —É–¥–∏–≤–∏—Ç–µ–ª—å–Ω–∞—è! üí´",
        "–î–∞–∂–µ –≤ —Å–∞–º—ã–π –æ–±—ã—á–Ω—ã–π –¥–µ–Ω—å –≤–∞–∂–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç—å –º–æ–º–µ–Ω—Ç—ã —Å—á–∞—Å—Ç—å—è! üå∏",
        "–¢–≤–æ—è —ç–Ω–µ—Ä–≥–∏—è –∏ –ø–æ–∑–∏—Ç–∏–≤ –∑–∞—Ä—è–∂–∞—é—Ç –≤—Å–µ—Ö –≤–æ–∫—Ä—É–≥! –¢–∞–∫ –¥–µ—Ä–∂–∞—Ç—å! üíù",
        "–ù–∞–¥–µ—é—Å—å, —Å–µ–≥–æ–¥–Ω—è —Ç–µ–±—è –∂–¥—É—Ç –ø—Ä–∏—è—Ç–Ω—ã–µ —Å—é—Ä–ø—Ä–∏–∑—ã! üéÅ",
        "–ü—É—Å—Ç—å —ç—Ç–æ—Ç –¥–µ–Ω—å –ø—Ä–∏–Ω–µ—Å–µ—Ç —Ç–µ–±–µ –º–Ω–æ–≥–æ —Ä–∞–¥–æ—Å—Ç–∏ –∏ —É—Å–ø–µ—Ö–æ–≤! üåà",
        "–¢—ã —Å–∏–ª—å–Ω–µ–µ, —á–µ–º –¥—É–º–∞–µ—à—å! –°–µ–≥–æ–¥–Ω—è –¥–µ–Ω—å –Ω–æ–≤—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π! ‚≠ê",
    ];
    
    let index = rand::thread_rng().gen_range(0..messages.len());
    messages[index].to_string()
}

// –ü–æ–∂–µ–ª–∞–Ω–∏–µ —Ö–æ—Ä–æ—à–µ–≥–æ –¥–Ω—è
fn get_good_day_wish() -> String {
    let wishes = [
        "–ñ–µ–ª–∞—é —Ç–µ–±–µ —á—É–¥–µ—Å–Ω–æ–≥–æ –¥–Ω—è! üí´",
        "–ü—É—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è —Ç–µ–±—è –æ–∫—Ä—É–∂–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ–∑–∏—Ç–∏–≤! üåà",
        "–•–æ—Ä–æ—à–µ–≥–æ –∏ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ–≥–æ –¥–Ω—è! ‚ú®",
        "–ñ–µ–ª–∞—é, —á—Ç–æ–±—ã —ç—Ç–æ—Ç –¥–µ–Ω—å –±—ã–ª –Ω–∞–ø–æ–ª–Ω–µ–Ω –ø—Ä–∏—è—Ç–Ω—ã–º–∏ –º–æ–º–µ–Ω—Ç–∞–º–∏! üíñ",
        "–ü—É—Å—Ç—å —Ç–≤–æ–π –¥–µ–Ω—å –±—É–¥–µ—Ç —Ç–∞–∫–∏–º –∂–µ –ø—Ä–µ–∫—Ä–∞—Å–Ω—ã–º, –∫–∞–∫ –∏ —Ç—ã! üå∏",
        "–í–µ—Ä—é, —á—Ç–æ —Å–µ–≥–æ–¥–Ω—è —É —Ç–µ–±—è –≤—Å—ë –ø–æ–ª—É—á–∏—Ç—Å—è! üí™",
        "–£–¥–∞—á–Ω–æ–≥–æ –¥–Ω—è –∏ –ª–µ–≥–∫–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è! üçÄ",
        "–ü—É—Å—Ç—å –∫–∞–∂–¥—ã–π —á–∞—Å —ç—Ç–æ–≥–æ –¥–Ω—è –ø–æ–¥–∞—Ä–∏—Ç —Ç–µ–±–µ —á—Ç–æ-—Ç–æ —Ö–æ—Ä–æ—à–µ–µ! ‚è∞",
        "–ü—Ä–µ–∫—Ä–∞—Å–Ω–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –Ω–∞ –≤–µ—Å—å –¥–µ–Ω—å! üåû",
        "–ü—É—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è –≤—Å—ë –∏–¥–µ—Ç –ø–æ —Ç–≤–æ–µ–º—É –ø–ª–∞–Ω—É! üìù"
    ];
    
    let index = rand::thread_rng().gen_range(0..wishes.len());
    wishes[index].to_string()
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
async fn send_mass_notifications(
    bot: &Bot, 
    users: &Vec<super::storage::UserSettings>, 
    weather_client: &WeatherClient,
    time: &str,
    day: Weekday
) {
    for user in users {
        if let Some(city) = &user.city {
            info!("–û—Ç–ø—Ä–∞–≤–∫–∞ –º–∞—Å—Å–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ID: {}, –≥–æ—Ä–æ–¥: {}", user.user_id, city);
            
            // –ü–æ–ª—É—á–∞–µ–º –ø–æ–≥–æ–¥—É
            match weather_client.get_weather(city).await {
                Ok(weather_text) => {
                    // –ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —Ä–µ–∂–∏–º–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    let message = if user.cute_mode {
                        // –ú–∏–ª—ã–π —Ä–µ–∂–∏–º: –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –º–∏–ª—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                        let greeting = if time == "12:00" {
                            get_noon_greeting(day)
                        } else {
                            get_evening_greeting(day)
                        };
                        
                        // –ü–æ–ª—É—á–∞–µ–º –º–∏–ª–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                        let cute_message = get_cute_message();
                        
                        // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
                        format!("{}\n\nüå¶ *–ü–æ–≥–æ–¥–∞ –≤ {}*\n\n{}\n\n{}", 
                            escape_markdown_v2(&greeting), 
                            escape_markdown_v2(city), 
                            escape_markdown_v2(&weather_text), 
                            escape_markdown_v2(&cute_message))
                    } else {
                        // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ä–µ–∂–∏–º: —Ç–æ–ª—å–∫–æ –ø–æ–≥–æ–¥–∞
                        let greeting = if time == "12:00" {
                            "üïõ *–î–Ω–µ–≤–Ω–æ–π –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã*".to_string()
                        } else {
                            "üåÜ *–í–µ—á–µ—Ä–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã*".to_string()
                        };
                        
                        format!("{}\n\nüå¶ *–ü–æ–≥–æ–¥–∞ –≤ {}*\n\n{}", 
                            greeting, 
                            escape_markdown_v2(city), 
                            escape_markdown_v2(&weather_text))
                    };
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                    if let Err(e) = bot.send_message(ChatId(user.user_id), message)
                        .parse_mode(teloxide::types::ParseMode::MarkdownV2)
                        .await 
                    {
                        error!("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –º–∞—Å—Å–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {}: {}", user.user_id, e);
                    } else {
                        info!("–ú–∞—Å—Å–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ID: {}", user.user_id);
                    }
                }
                Err(e) => {
                    warn!("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–≥–æ–¥—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {}: {}", user.user_id, e);
                }
            }
        }
    }
}

// –î–Ω–µ–≤–Ω—ã–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
fn get_noon_greeting(day: Weekday) -> String {
    match day {
        Weekday::Mon => "*–î–æ–±—Ä—ã–π –¥–µ–Ω—å!* üå§Ô∏è\n–ù–∞–¥–µ—é—Å—å, –ø–µ—Ä–≤–∞—è –ø–æ–ª–æ–≤–∏–Ω–∞ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞ –ø—Ä–æ—à–ª–∞ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ!".to_string(),
        Weekday::Tue => "*–î–æ–±—Ä—ã–π –¥–µ–Ω—å!* ‚òÄÔ∏è\n–í—Ç–æ—Ä–Ω–∏–∫ –≤ —Å–∞–º–æ–º —Ä–∞–∑–≥–∞—Ä–µ! –ö–∞–∫ –ø—Ä–æ—Ö–æ–¥–∏—Ç —Ç–≤–æ–π –¥–µ–Ω—å?".to_string(),
        Weekday::Wed => "*–î–æ–±—Ä—ã–π –¥–µ–Ω—å!* üåà\n–°–µ—Ä–µ–¥–∏–Ω–∞ –Ω–µ–¥–µ–ª–∏ - –≤—Ä–µ–º—è –¥–ª—è –Ω–µ–±–æ–ª—å—à–æ–≥–æ –ø–µ—Ä–µ—Ä—ã–≤–∞ –∏ –≤–∫—É—Å–Ω–æ–≥–æ –æ–±–µ–¥–∞!".to_string(),
        Weekday::Thu => "*–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –¥–Ω—è!* üåª\n–ß–µ—Ç–≤–µ—Ä–≥ - –ø–æ—á—Ç–∏ –ø—è—Ç–Ω–∏—Ü–∞! –î–µ—Ä–∂–∏—Å—å, –æ—Å—Ç–∞–ª–æ—Å—å —Å–æ–≤—Å–µ–º –Ω–µ–º–Ω–æ–≥–æ!".to_string(),
        Weekday::Fri => "*–î–æ–±—Ä—ã–π –¥–µ–Ω—å!* üéâ\n–ü—è—Ç–Ω–∏—Ü–∞, –¥–µ–Ω—å –ø—Ä–µ–∫—Ä–∞—Å–Ω—ã–π! –°–∫–æ—Ä–æ –≤—ã—Ö–æ–¥–Ω—ã–µ!".to_string(),
        Weekday::Sat => "*–ü—Ä–µ–∫—Ä–∞—Å–Ω–æ–≥–æ –¥–Ω—è!* üçπ\n–ù–∞–¥–µ—é—Å—å, —Ç–≤–æ—è —Å—É–±–±–æ—Ç–∞ –Ω–∞–ø–æ–ª–Ω–µ–Ω–∞ –ø—Ä–∏—è—Ç–Ω—ã–º–∏ –º–æ–º–µ–Ω—Ç–∞–º–∏!".to_string(),
        Weekday::Sun => "*–î–æ–±—Ä—ã–π –¥–µ–Ω—å!* üåû\n–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ - –≤—Ä–µ–º—è –æ—Ç–¥—ã—Ö–∞ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –Ω–æ–≤–æ–π –Ω–µ–¥–µ–ª–µ!".to_string(),
    }
}

// –í–µ—á–µ—Ä–Ω–∏–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
fn get_evening_greeting(day: Weekday) -> String {
    match day {
        Weekday::Mon => "*–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä!* üåô\n–ü–µ—Ä–≤—ã–π –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –ø–æ—á—Ç–∏ –ø–æ–∑–∞–¥–∏! –¢—ã –º–æ–ª–æ–¥–µ—Ü!".to_string(),
        Weekday::Tue => "*–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä!* üåÜ\n–ö–∞–∫ –ø—Ä–æ—à–µ–ª —Ç–≤–æ–π –≤—Ç–æ—Ä–Ω–∏–∫? –ù–∞–¥–µ—é—Å—å, –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ –∏ —Å —É–ª—ã–±–∫–æ–π!".to_string(),
        Weekday::Wed => "*–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä!* ‚ú®\n–°–µ—Ä–µ–¥–∏–Ω–∞ –Ω–µ–¥–µ–ª–∏ –ø–æ–∑–∞–¥–∏! –¢—ã —É–∂–µ –Ω–∞ –ø—É—Ç–∏ –∫ –≤—ã—Ö–æ–¥–Ω—ã–º!".to_string(),
        Weekday::Thu => "*–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –≤–µ—á–µ—Ä–∞!* üåü\n–ó–∞–≤—Ç—Ä–∞ –ø—è—Ç–Ω–∏—Ü–∞! –°–æ–≤—Å–µ–º –Ω–µ–º–Ω–æ–≥–æ –æ—Å—Ç–∞–ª–æ—Å—å!".to_string(),
        Weekday::Fri => "*–ü—Ä–µ–∫—Ä–∞—Å–Ω–æ–≥–æ –≤–µ—á–µ—Ä–∞!* ü•Ç\n–ü–æ–∑–¥—Ä–∞–≤–ª—è—é —Å –Ω–∞—á–∞–ª–æ–º –≤—ã—Ö–æ–¥–Ω—ã—Ö! –ü–æ—Ä–∞ –æ—Ç–¥–æ—Ö–Ω—É—Ç—å!".to_string(),
        Weekday::Sat => "*–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä!* üé≠\n–ù–∞–¥–µ—é—Å—å, —Å—É–±–±–æ—Ç–∞ –±—ã–ª–∞ –Ω–∞–ø–æ–ª–Ω–µ–Ω–∞ –ø—Ä–∏—è—Ç–Ω—ã–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏!".to_string(),
        Weekday::Sun => "*–°–ø–æ–∫–æ–π–Ω–æ–≥–æ –≤–µ—á–µ—Ä–∞!* üå†\n–í–ø–µ—Ä–µ–¥–∏ –Ω–æ–≤–∞—è –Ω–µ–¥–µ–ª—è! –í—Ä–µ–º—è –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å—Å—è –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ã–π –ª–∞–¥!".to_string(),
    }
}